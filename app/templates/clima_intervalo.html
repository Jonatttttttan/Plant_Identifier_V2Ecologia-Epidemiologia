{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="max-width: 700px;">

  <h2 class="text-center mb-4">Histórico de Temperaturas (Open-Meteo)</h2>

  <form method="POST" class="card p-4 shadow-sm mb-4">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Latitude</label>
        <input
          type="text"
          name="latitude"
          class="form-control"
          placeholder="-15.8"
          value="{{ latitude or '' }}"
          required
        >
      </div>
      <div class="col-md-6">
        <label class="form-label">Longitude</label>
        <input
          type="text"
          name="longitude"
          class="form-control"
          placeholder="-47.9"
          value="{{ longitude or '' }}"
          required
        >
      </div>
      <div class="col-md-6">
        <label class="form-label">Ano inicial</label>
        <input
          type="number"
          name="ano_inicio"
          class="form-control"
          placeholder="2015"
          value="{{ ano_inicio or '' }}"
          min="1950"
          max="2100"
          required
        >
      </div>
      <div class="col-md-6">
        <label class="form-label">Ano final</label>
        <input
          type="number"
          name="ano_fim"
          class="form-control"
          placeholder="2024"
          value="{{ ano_fim or '' }}"
          min="1950"
          max="2100"
          required
        >
      </div>
      <div class="col-md-6">
        <label class="form-label">Frequência</label>
        <select name="frequencia" class="form-select">
          <option value="mensal" {{ 'selected' if frequencia == 'mensal' }}>Mensal</option>
          <option value="semanal" {{ 'selected' if frequencia == 'semanal' }}>Semanal</option>
        </select>
      </div>
    </div>

    <button class="btn btn-primary w-100 mt-3">Buscar histórico</button>
  </form>

  {% if erro %}
  <div class="alert alert-danger">{{ erro }}</div>
  {% endif %}

  {% if dados %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">
        Temperatura média {{ 'mensal' if frequencia == 'mensal' else 'semanal' }}
        ({{ ano_inicio }}–{{ ano_fim }})
      </h5>

      <!-- TABELA (opcional, pode remover se quiser só o gráfico) -->
      <table class="table table-sm table-striped mb-0">
        <thead>
          <tr>
            <th>Ano</th>
            <th>{{ 'Mês' if frequencia == 'mensal' else 'Semana' }}</th>
            <th>Temperatura média (°C)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in dados %}
          <tr>
            <td>{{ row.ano }}</td>
            <td>{{ row.indice }}</td>
            <td>
              {% if row.temperatura_media is not none %}
                {{ row.temperatura_media | round(2) }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- GRÁFICOS: um por ano -->
  {% if dados_por_ano %}
    <h4 class="mb-3">Gráficos por ano</h4>

    {% for ano, serie in dados_por_ano.items() %}
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">
          {{ 'Temperatura média semanal' if frequencia == 'semanal' else 'Temperatura média mensal' }}
          – {{ ano }}
        </h5>
        <canvas id="chart-{{ ano }}" height="120"></canvas>
      </div>
    </div>
    {% endfor %}
  {% endif %}
{% endif %}


</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // dados_por_ano vem do Flask como JSON
  const dadosPorAno = {{ dados_por_ano|tojson or '{}' }};
  const frequencia = "{{ frequencia }}";

  // Cria um gráfico para cada ano
  Object.keys(dadosPorAno).forEach(ano => {
    const serie = dadosPorAno[ano];
    const ctx = document.getElementById('chart-' + ano);
    if (!ctx) return;

    const labels = serie.indices;
    const data = serie.temperaturas;

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: `Temperatura média (${frequencia}) - ${ano}`,
          data: data,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: frequencia === 'semanal' ? 'Semana' : 'Mês'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Temperatura (°C)'
            }
          }
        }
      }
    });
  });
</script>

{% endblock %}
