{% extends "base.html" %}

{% block content %}
<style>
  /* ---------- Estilo geral ---------- */
  .page-title {
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* ---------- Card de leis ---------- */
  .leis-card {
    border-left: 6px solid #198754;
    background: linear-gradient(135deg, #f8fff9, #ffffff);
    animation: fadeInUp 0.4s ease-in-out;
  }

  .leis-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .leis-ano-badge {
    background-color: #198754;
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
  }

  .leis-lista li {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    padding: 10px 14px;
    border-radius: 6px;
    margin-bottom: 8px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .leis-lista li:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* ---------- Anima√ß√£o ---------- */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(12px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ---------- Dica ---------- */
  .hint {
    font-size: 0.9rem;
    color: #6c757d;
    text-align: center;
    margin-top: 10px;
  }
</style>

<div class="container py-4" style="max-width: 1000px;">
  <h2 class="text-center mb-4 page-title">üå≥ √Årea Florestal (% do territ√≥rio)</h2>

  <!-- Formul√°rio -->
  <form method="POST" class="card p-4 shadow-sm mb-4">
    <label class="form-label fw-semibold">Selecione um pa√≠s</label>
    <select name="pais" class="form-select" required>
      {% for nome, code in paises.items() %}
        <option value="{{ code }}" {% if pais_escolhido == code %}selected{% endif %}>
          {{ nome }}
        </option>
      {% endfor %}
    </select>

    <button class="btn btn-primary w-100 mt-3">
      üìä Ver gr√°fico
    </button>
  </form>

  {% if erro %}
    <div class="alert alert-danger">{{ erro }}</div>
  {% endif %}

  {% if anos and valores %}
    <!-- Gr√°fico -->
    <div class="card shadow-sm">
      <div class="card-body">
        <canvas id="chart-florestas" height="120"></canvas>

        <div class="hint">
          {% if is_brasil %}
            Clique em um ano do gr√°fico para ver as leis ambientais daquele per√≠odo
          {% else %}
            Leis ambientais dispon√≠veis apenas para Brasil
          {% endif %}
        </div>

        {% if is_brasil %}
          <!-- Card de Leis -->
          <div class="card shadow-sm mt-4 leis-card" id="leis-card" style="display:none;">
            <div class="card-body">
              <div class="leis-header mb-3">
                <h5 class="mb-0">üìú Leis ambientais</h5>
                <span class="leis-ano-badge" id="leis-ano"></span>
              </div>

              <div id="leis-status" class="text-muted mb-3"></div>

              <ul id="leis-lista" class="list-unstyled leis-lista mb-0"></ul>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="text-center text-muted">Nenhum dado retornado.</p>
  {% endif %}
</div>

{% if anos and valores %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const anos = {{ anos|tojson }};
  const valores = {{ valores|tojson }};
  const isBrasil = {{ (is_brasil|tojson) }};

  const chart = new Chart(document.getElementById("chart-florestas"), {
    type: "line",
    data: {
      labels: anos,
      datasets: [{
        label: "√Årea florestal (% do territ√≥rio)",
        data: valores,
        tension: 0.25,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      onClick: async (evt, elements) => {
        if (!isBrasil || !elements.length) return;

        const ano = anos[elements[0].index];

        const card = document.getElementById("leis-card");
        const anoSpan = document.getElementById("leis-ano");
        const statusDiv = document.getElementById("leis-status");
        const ul = document.getElementById("leis-lista");

        card.style.display = "block";
        anoSpan.textContent = ano;
        statusDiv.textContent = "üîÑ Carregando leis...";
        ul.innerHTML = "";

        try {
          const resp = await fetch(`/florestas/leis/${ano}`);
          const data = await resp.json();

          if (!resp.ok) {
            statusDiv.textContent = "‚ùå Erro ao buscar leis.";
            return;
          }

          const leis = data.leis || [];
          if (leis.length === 0) {
            statusDiv.textContent = "Nenhuma lei cadastrada para este ano.";
            return;
          }

          statusDiv.textContent = `Foram encontradas ${leis.length} leis/medidas:`;
          leis.forEach(lei => {
            const li = document.createElement("li");
            li.textContent = lei;
            ul.appendChild(li);
          });
        } catch (e) {
          statusDiv.textContent = "‚ö†Ô∏è Falha de rede ao buscar leis.";
        }
      },
      scales: {
        x: { title: { display: true, text: "Ano" } },
        y: { title: { display: true, text: "% do territ√≥rio" } }
      }
    }
  });
</script>
{% endif %}

{% endblock %}
